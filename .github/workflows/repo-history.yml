name: Save Repo History

permissions:
  contents: write

on:
  schedule:
    - cron: "0 0 * * *"
  workflow_dispatch:

jobs:
  save-history:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Install jq
        run: sudo apt-get install jq -y

      # -----------------------------
      # 1. SAVE CLONE HISTORY
      # -----------------------------
      - name: Fetch clone stats
        run: |
          mkdir -p traffic
          DATE=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

          RESPONSE=$(curl -s \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            https://api.github.com/repos/${{ github.repository }}/traffic/clones)

          COUNT=$(echo "$RESPONSE" | jq '.count')
          UNIQUES=$(echo "$RESPONSE" | jq '.uniques')

          if [ ! -f traffic/clone-history.csv ]; then
            echo "timestamp,total_clones,unique_cloners" > traffic/clone-history.csv
          fi

          echo "$DATE,$COUNT,$UNIQUES" >> traffic/clone-history.csv

      # -----------------------------
      # 2. SAVE VIEW HISTORY (75 views)
      # -----------------------------
      - name: Fetch view stats
        run: |
          mkdir -p traffic
          DATE=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

          RESPONSE=$(curl -s \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            https://api.github.com/repos/${{ github.repository }}/traffic/views)

          COUNT=$(echo "$RESPONSE" | jq '.count')
          UNIQUES=$(echo "$RESPONSE" | jq '.uniques')

          if [ ! -f traffic/view-history.csv ]; then
            echo "timestamp,total_views,unique_visitors" > traffic/view-history.csv
          fi

          echo "$DATE,$COUNT,$UNIQUES" >> traffic/view-history.csv

      # -----------------------------
      # 3. SAVE VISIBILITY HISTORY
      # -----------------------------
      - name: Fetch visibility
        run: |
          mkdir -p visibility
          DATE=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

          RESPONSE=$(curl -s \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            https://api.github.com/repos/${{ github.repository }})

          VISIBILITY=$(echo "$RESPONSE" | jq -r '.private')

          if [ ! -f visibility/visibility-history.csv ]; then
            echo "timestamp,private" > visibility/visibility-history.csv
          fi

          LAST=$(tail -n 1 visibility/visibility-history.csv | cut -d',' -f2)

          if [ "$LAST" != "$VISIBILITY" ]; then
            echo "$DATE,$VISIBILITY" >> visibility/visibility-history.csv
          fi

      # -----------------------------
      # 4. COMMIT CHANGES
      # -----------------------------
      - name: Commit results
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add traffic/*.csv visibility/*.csv
          git commit -m "Update repo history: $(date -u)" || echo "No changes to commit"
          git push
